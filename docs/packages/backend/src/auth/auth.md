# Authentication Module (`auth`)

## 1. Overview

The `auth` module is responsible for all aspects of user authentication, authorization, and session management within the application. It provides a comprehensive set of features including local (email/password) authentication, Google OAuth, Two-Factor Authentication (2FA), and secure token-based sessions.

## 2. Key Components

-   **`AuthModule`**: The root module that orchestrates all components.
-   **`AuthController`**: The primary controller handling endpoints for registration, login, password management, and OAuth.
-   **`TwoFactorAuthenticationController`**: A dedicated controller for all 2FA-related endpoints.
-   **`AuthService`**: The core service containing the business logic for user validation, token generation, and session management.
-   **`TwoFactorAuthenticationService`**: A service focused on generating secrets, QR codes, and validating 2FA codes.
-   **Guards**: A set of NestJS guards (`JwtAuthGuard`, `LocalAuthGuard`, `RefreshTokenGuard`) used to protect routes and enforce authentication policies.
-   **Passport.js Strategies**: Multiple strategies (`LocalStrategy`, `JwtStrategy`, `GoogleStrategy`, etc.) that define the logic for different authentication mechanisms.

## 3. Core Authentication Flow (Email/Password)

The standard authentication flow uses JWT (JSON Web Tokens) for stateless sessions.

1.  **Registration (`POST /auth/register`)**: A new user provides their email, password, and full name. The system creates a user record and sends a verification email.
2.  **Email Verification (`GET /auth/verify-email`)**: The user clicks a link in the email containing a one-time token to verify their email address.
3.  **Login (`POST /auth/login`)**: The user submits their email and password.
    -   The `LocalAuthGuard` and `LocalStrategy` validate the credentials.
    -   If successful, the `AuthService` generates an `accessToken` (short-lived) and a `refreshToken` (long-lived).
    -   The `accessToken` is returned in the response body.
    -   The `refreshToken` is set in a secure, `HttpOnly` cookie.
4.  **Authenticated Requests**: The client sends the `accessToken` in the `Authorization: Bearer <token>` header for all subsequent requests to protected endpoints. The `JwtAuthGuard` validates this token.
5.  **Token Refresh (`GET /auth/refresh`)**: When the `accessToken` expires, the client calls this endpoint. The `RefreshTokenGuard` validates the `refreshToken` from the cookie and issues a new pair of access and refresh tokens.

### Usage Example (Frontend)

```typescript
import axios from 'axios';

// 1. User Registration
await axios.post('/api/v1/auth/register', {
  email: 'test@example.com',
  password: 'StrongPassword123!',
  fullName: 'Test User'
});
// User then verifies their email.

// 2. User Login
const response = await axios.post('/api/v1/auth/login', {
  email: 'test@example.com',
  password: 'StrongPassword123!'
});
const { accessToken } = response.data;

// 3. Making an Authenticated Request
const profile = await axios.get('/api/v1/users/profile', {
  headers: {
    'Authorization': `Bearer ${accessToken}`
  }
});
```

## 4. Two-Factor Authentication (2FA)

The module supports TOTP (Time-based One-Time Password) for 2FA.

-   **`POST /2fa/generate`**: Generates a new 2FA secret and a corresponding QR code for the authenticated user to scan with an authenticator app.
-   **`POST /2fa/turn-on`**: The user provides a code from their app to verify and enable 2FA on their account.
-   **`POST /2fa/authenticate`**: After logging in, if 2FA is enabled, the user must provide a code to this endpoint to complete the login process.
-   **`POST /2fa/turn-off`**: Disables 2FA for the user's account after successful code verification.

## 5. Google OAuth & Account Linking

The module supports both logging in with Google and linking a Google account to an existing email/password account.

-   **Login (`GET /auth/google`)**: Initiates the Google OAuth flow for new or returning users.
-   **Account Linking (`GET /auth/link-google`)**: For an already authenticated user, this initiates a flow to link their Google account. This allows them to log in using either method in the future.
-   **Unlinking (`POST /auth/unlink-oauth`)**: Allows a user to remove the Google account link, provided they have a password set as an alternative login method.

*(For a detailed guide on the Google Account Linking flow, refer to the `LINK_GOOGLE_ACCOUNT.md` file within this module.)*

---
**Note:** This documentation provides a high-level overview. For detailed information on request/response schemas, please refer to the live API documentation generated by Swagger, available at the `/api` endpoint when the application is running.
