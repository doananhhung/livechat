# Architecture

> Auto-generated by /map on 2026-01-19

## Overview

**Live Chat SaaS Platform** — Multi-tenant real-time customer support system with embeddable widget.

```
┌─────────────────────────────────────────────────────────────────┐
│                     Frontend (React + Vite)                     │
│   ┌──────────────────────┐    ┌──────────────────────────────┐  │
│   │   Agent Dashboard    │    │  Embeddable Widget (Preact)  │  │
│   └──────────────────────┘    └──────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │  ▲
                    REST API  │  │  WebSocket (Socket.IO)
                              ▼  │
┌─────────────────────────────────────────────────────────────────┐
│                      Backend (NestJS)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ Controllers │──│  Services   │──│ Guards (JWT + RBAC)     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   Gateway   │  │ Event Emit  │  │ @Auditable Interceptor  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         ▼                    ▼                    ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐
│   PostgreSQL    │  │     Redis       │  │   BullMQ Worker     │
│  (TypeORM)      │  │  (Cache/Pub)    │  │  (Background Jobs)  │
└─────────────────┘  └─────────────────┘  └─────────────────────┘
```

## Packages (Monorepo)

| Package                   | Path                    | Purpose                                 |
| ------------------------- | ----------------------- | --------------------------------------- |
| `@live-chat/backend`      | `packages/backend`      | NestJS API + WebSocket Gateway + Worker |
| `@live-chat/frontend`     | `packages/frontend`     | React Dashboard + Preact Widget         |
| `@live-chat/shared-dtos`  | `packages/shared-dtos`  | Request/Response DTOs with validation   |
| `@live-chat/shared-types` | `packages/shared-types` | TypeScript interfaces and enums         |

## Backend Modules

| Module             | Purpose                        | Key Files |
| ------------------ | ------------------------------ | --------- |
| `auth`             | JWT, OAuth, 2FA authentication | 24 files  |
| `projects`         | Multi-tenant isolation         | 8 files   |
| `inbox`            | Conversations + messages       | 17 files  |
| `gateway`          | Socket.IO WebSocket layer      | 9 files   |
| `visitors`         | Widget visitor management      | 8 files   |
| `webhooks`         | Outbound webhook delivery      | 8 files   |
| `audit-logs`       | Activity tracking              | 9 files   |
| `canned-responses` | Quick reply templates          | 4 files   |
| `actions`          | Action templates/triggers      | 7 files   |
| `mail`             | SMTP email service             | 6 files   |
| `screenshot`       | URL screenshot capture         | 3 files   |
| `visitor-notes`    | Agent notes on visitors        | 3 files   |
| `event-consumer`   | BullMQ job consumers           | 6 files   |
| `event-producer`   | Event emission                 | 2 files   |
| `rbac`             | Role-based access control      | 4 files   |
| `realtime-session` | Socket session tracking        | 3 files   |
| `users`            | User profile management        | 7 files   |

## Frontend Structure

| Directory     | Purpose                              |
| ------------- | ------------------------------------ |
| `components/` | 64 UI components (shadcn/ui pattern) |
| `pages/`      | 20 route pages                       |
| `services/`   | 8 API client services                |
| `stores/`     | 4 Zustand stores                     |
| `widget/`     | 23 files for embeddable widget       |
| `hooks/`      | Custom React hooks                   |
| `contexts/`   | React context providers              |
| `i18n/`       | Internationalization (i18next)       |
| `lib/`        | Utilities and helpers                |

## Data Flow Patterns

### 1. Visitor Message → Agent Dashboard

```
Widget → Socket.IO → Gateway → EventEmitter → BullMQ Queue
                                                    ↓
                                              Worker (DB write)
                                                    ↓
                                              Outbox Pattern
                                                    ↓
                                           PG NOTIFY → Redis Pub/Sub
                                                    ↓
                                           Gateway → Dashboard (broadcast)
```

### 2. Agent Reply → Widget

```
Dashboard → REST API → MessageService → PostgreSQL
                            ↓
               Redis lookup (visitor socket)
                            ↓
                      Gateway → Widget
                            ↓
             Broadcast NEW_MESSAGE → other agents
```

### 3. Lazy Conversation Creation

Conversations created ONLY on first message, not widget open — prevents ghost conversations.

## Key Patterns

| Pattern                  | Location                 | Purpose                    |
| ------------------------ | ------------------------ | -------------------------- |
| **Transactional Outbox** | Message processing       | Atomic DB + event delivery |
| **Optimistic UI**        | Frontend message sending | Zero-latency feel          |
| **Decorator Audit**      | `@Auditable` interceptor | Automatic activity logging |
| **Domain Whitelisting**  | Widget connection        | SSRF protection            |
| **HMAC Signatures**      | Webhooks                 | Payload authenticity       |
| **Room-based Events**    | Socket.IO `project:{id}` | Tenant isolation           |

## Security Model

| Layer              | Protection                                                  |
| ------------------ | ----------------------------------------------------------- |
| **Authentication** | JWT access + refresh rotation + 2FA (TOTP) + OAuth (Google) |
| **Authorization**  | RolesGuard with ProjectMember validation (MANAGER > AGENT)  |
| **Widget**         | Domain whitelist + visitor UID binding                      |
| **Screenshots**    | SSRF blocking (private IPs, metadata endpoints)             |
| **Webhooks**       | HTTPS-only + SSRF protection + HMAC                         |
| **Audit**          | Fail-open logging with sensitive data redaction             |

## Technical Debt

- [ ] No TODOs/FIXMEs in source code (clean)
- [ ] 19 outdated packages (minor version updates only)
- [ ] Docker deployment marked as experimental
- [ ] No E2E tests for frontend widget

## Conventions

**Naming:**

- Backend: PascalCase for classes, camelCase for functions
- Frontend: PascalCase components, kebab-case files
- DTOs: Suffix with `Dto` (e.g., `CreateMessageDto`)

**Structure:**

- Feature modules with controller/service/entity/dto pattern
- Shared packages for cross-boundary types

**Testing:**

- Backend: Jest (unit + E2E)
- Frontend: Vitest

## Further Reading

See `docs/deep_investigation/` for 18 detailed flow documents.
