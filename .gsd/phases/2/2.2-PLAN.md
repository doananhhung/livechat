---
phase: 2
plan: 2
wave: 1
---

# Plan 2.2: Transactional Submission

## Objective

Enforce the **Atomicity Law** by refactoring `submitFormAsVisitor` to execute the submission save and message creation within a single database transaction. This ensures that if message creation fails, the submission is rolled back, preventing orphaned data.

## Context

- [actions.service.ts](file:///home/hoang/node/live_chat/packages/backend/src/actions/actions.service.ts)
- [actions.service.spec.ts](file:///home/hoang/node/live_chat/packages/backend/src/actions/actions.service.spec.ts)

## Tasks

<task type="auto">
  <name>Refactor ActionsService for Transactions</name>
  <files>packages/backend/src/actions/actions.service.ts</files>
  <action>
    1. Inject `DataSource` into `ActionsService`.
    2. Wrap the logic in `submitFormAsVisitor` within `this.dataSource.transaction(async manager => { ... })`.
    3. Update repository calls to use the transactional `manager` (e.g., `manager.save(ActionSubmission, ...)`).
  </action>
  <verify>
    Check code for transaction wrapper and usage of `manager` instead of `this.repo`.
  </verify>
  <done>Code uses transaction manager for both writes</done>
</task>

<task type="auto">
  <name>Update Unit Tests</name>
  <files>packages/backend/src/actions/actions.service.spec.ts</files>
  <action>
    Update the `ActionsService` test suite to mock `DataSource` and its transaction runner.
    1. Mock `dataSource.transaction` to execute the callback immediately.
    2. Ensure tests verify that `manager.save` is called, not the repository directly (or mock the manager to behave like the repo).
  </action>
  <verify>
    npm run test --workspace=@live-chat/backend -- actions.service.spec.ts
  </verify>
  <done>Tests pass with transaction mocking</done>
</task>

## Success Criteria

- [ ] `submitFormAsVisitor` uses a single transaction
- [ ] No changes to external API behavior
- [ ] Tests pass (preserving regression safety)
